name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  rag-service:
    name: rag_service (lint, typecheck, test)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: rag_service

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]

    env:
      PYTHONPATH: src

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password
          POSTGRES_DB: ambience_knowledge_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: |
            rag_service/pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Ruff (lint)
        run: ruff check .

      - name: Ruff (format check)
        run: ruff format --check .

      - name: MyPy (typecheck)
        run: mypy src

      - name: Pytest (with coverage)
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password
          POSTGRES_DB: ambience_knowledge_test
          EMBEDDING_MODEL: all-MiniLM-L6-v2
          EMBEDDING_DIMENSION: 384
          CHUNK_SIZE: 450
          CHUNK_OVERLAP: 100
          LOG_LEVEL: INFO
          LOG_FILE: logs/rag.log
        run: pytest --cov=src --cov-report=term --cov-fail-under=90